<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="profile.jpg">
    <title>Locate</title>
    <script>
const { dialog } = require('electron').remote;
const os = require('os');
const find = require('find');
const { shell } = require('electron');


window.onload = function() {
  if (localStorage.profiles == null) {
    autodetect();
  } else {
    toggleStatus(true);
  }
}

function autodetect() {
  toggleStatus(false);
  switch (process.platform) { // TODO: find launcher for macOS and linux
    case 'win32':
      localStorage.profiles = process.env["APPDATA"] + '\\.minecraft';
      localStorage.launcher = process.env["ProgramFiles(x86)"] + '\\Minecraft\\MinecraftLauncher.exe';
      break;
    case 'darwin':
      localStorage.profiles = os.homedir() + '\\Library\\Application Support\\minecraft';
      break;
    default:  // linux
      localStorage.profiles = os.homedir() + '\\.minecraft';
  }
  localStorage.profiles += '\\launcher_profiles.json';
  location.reload();
}

/*function search(target) { console.log('searching...');
// search for .minecraft or minecraft folders
  document.getElementById('advanced').style.display = 'initial';  // show locate button
  target.style.display = 'none';

  find
  .eachdir(/minecraft$/i, os.homedir(), function(dir) {
    var item = document.createElement('li');
    item.innerText = dir;
    item.onclick = function() {
      if (warnUser(this.innerText)) {
        localStorage.MCpath = this.innerText;
        location.reload();
      }
    }
    document.querySelector('ul').appendChild(item);
  })
  .end(function() {
    console.log('find end');
  })
}*/

function locate() {
  dialog.showOpenDialog({properties: ['openDirectory']}, function (folder) { console.log(folder);
    if (folder !== undefined && warnUser(folder[0])) {
      localStorage.profiles = folder;
    }
    location.reload();
  });
}

function validateFolder(folder) {  // TODO
  return false;
}

function warnUser(folder) {
  if (!validateFolder(folder)) {  // folder not valid
    var result = dialog.showMessageBox({
      type: 'question',
      message: "Are you sure this is a valid MC directory:\n" + folder,
      title: "Confirm",
      buttons: ['no', 'yes', 'Open in files']  // returns 1=yes, 0=no, 2=open
    });
    if (result != 2) return result;
    shell.showItemInFolder(folder);
    return 0;
  }
  else return true;  // folder is valid
}

function toggleStatus(isDone) {
  document.getElementById('loading').style.display = (isDone) ? 'none' : 'initial';
  document.getElementById('done').style.display = (isDone) ? 'initial' : 'none';
  document.querySelector('#done > code').innerText = localStorage.profiles;
}
    </script>
    <style>
code {
  background-color: lightgrey;
  padding: 5px;
  /*round corners*/
}

p {
  display: none;
  font-size: 1em;
}

img {
  height: 2em;
}

li {
  text-decoration: underline;
  color: blue;
  cursor: pointer;
}

[onclick] {
  cursor: pointer;
}

li:active {
  color: red;
}
    </style>
  </head>
  <body>
    <p id=loading><img src="infinity-loading.svg" />  Locating your Minecraft folder...</p>
    <p id=done>Minecraft has been detected at
      <code onclick='shell.showItemInFolder(this.innerText)'>${ localStorage.profiles }</code>
      <button onclick="autodetect()">Auto-detect</button>
      <button onclick="locate(event.target)">Incorrect?</button>
    </p>
    <ul></ul>
    <div id=advanced style="display: none;">
      <img src="infinity-loading.svg" /> Searching...
      <button onclick="locate()">Locate</button>
    </div>
  </body>
</html>
